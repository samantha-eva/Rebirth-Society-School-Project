{% extends 'base.html.twig' %}

{% block title %}Paiement{% endblock %}

{% block body %}
<main class="py-10">
    <div class="mx-auto max-w-lg px-4 sm:px-6 lg:px-8">
        <div class="bg-black/50 shadow-lg sm:rounded-lg border border-gray-800">
            <div class="px-4 py-8 sm:p-10">
                <h2 class="text-2xl font-bold leading-7 text-white text-center">Paiement Sécurisé</h2>
                <p class="mt-2 text-sm text-gray-400 text-center">
                    Finalisez votre transaction en toute sécurité via Stripe.
                </p>

                <!-- Stripe Form -->
                <div class="mt-8 space-y-6">
                    <div id="payment-form" class="p-4 bg-gray-900 rounded-md border border-gray-700"></div>

                    <!-- Bouton -->
                    <button id="submit"
                        class="w-full rounded-md bg-[var(--primary-color)] px-3 py-4 text-lg font-semibold text-black shadow-sm hover:bg-yellow-400 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[var(--primary-color)]">
                        Payer Maintenant
                    </button>
                </div>

                <!-- Message sécurité -->
                <p class="mt-6 text-xs text-gray-500 text-center">
                    <span class="material-symbols-outlined align-middle text-sm">lock</span>
                    Paiements sécurisés et cryptés avec Stripe.
                </p>
            </div>
        </div>
    </div>
</main>

<!-- Stripe Script -->
<script src="https://js.stripe.com/v3/"></script>
<script>
    const stripe = Stripe("{{ stripe_public_key }}");

    fetch("{{ path('create_payment_intent') }}", {
        method: "POST"
    })
    .then(response => response.json())
    .then(data => {
        const elements = stripe.elements({ clientSecret: data.clientSecret });
        const paymentElement = elements.create("payment");
        paymentElement.mount("#payment-form");

        const formButton = document.getElementById("submit");
        formButton.addEventListener("click", async () => {
            const { error } = await stripe.confirmPayment({
                elements,
                confirmParams: {
                    return_url: "{{ url('payment_success') }}",
                },
            });
            if (error) {
                alert(error.message);
            }
        });
    });
</script>
{% endblock %}
